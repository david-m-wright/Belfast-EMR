---
title: "DMO in BHSCT Macular Service - Analysis Notes"
author: "David M Wright - d.wright@qub.ac.uk"
date: "Document compiled: `r Sys.Date()`"
output: 
  bookdown::html_document2:
     toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(rprojroot)
```

`r R.version.string`   

This analysis is of Electronic Medical Records (EMR) from the Belfast Health and Social Care Trust Macular Service.

```{r run-analysis, include=FALSE}
source(find_rstudio_root_file("Code/assemble-EMR-data.R"))
```

# Cohort construction

## Pre-processing 

The data structure is defined in the file `Novartis DMO Study - Data Dictionary v1.1.xls` and a total of 18 separate pipe delimited files were provided.

Data were extracted on `r as.Date(max(patients$ExtractDate))`.

The following steps were taken to pre-process the data:   

* Removal of a small number of injections that were not for anti-VEGF agents.
* Removal of a small number of duplicate injection entries.   
* Identification of the first injection recorded for each eye and the date (the index date).   
* Calculation of patient ages at the index date and at study period end and total observation period for each patient.   


## Inclusion and exclusion criteria

Data were extracted by Medisoft with the following inclusion  and  exclusion criteria. 

Inclusion: "Any patient having attended the BHSCT macular treatment service at least once during the period May 2008 to date of extraction with a diagnosis DR/DMO."
Exclusion: "Any patient marked as a test patient."

EMR for a total of `r nrow(patients)` patients were included in the extracted dataset, with `r nrow(injections)` records of anti-VEGF injections. The unit of analysis is the eye so criteria were applied at the eye level:   

* `r nrow(eye_raw)` eyes received at least one anti-VEGF injection.   
* `r nrow(filter(eye_raw, exclude_age))` eyes were in patients aged <18 at the index date.
* `r nrow(filter(eye_raw, !exclude_age, exclude_no_intervals))` eyes that received no injections after the index date were excluded.

A total of `r nrow(eye)` eyes from `r nrow(distinct(eye, PatientID))` patients remained after these exclusions. A total of `r as.integer(sum(eye$total_intervals))` treatment intervals were observed (between injections). 


```{r descriptives}
indiv %>% 
  transmute(Age = index_age, Gender, Treated, Individuals = " ") %>% 
  GenerateDescriptives(type = c(Age = "Median (Range)")) %>% 
  kbl(caption = "Baseline demographics and characteristics of patients with DMO. Frequency and percentage reported for categorical variables.") %>% 
  kable_paper()

```

