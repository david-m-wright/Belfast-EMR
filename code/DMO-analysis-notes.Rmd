---
title: "DMO in BHSCT Macular Service - Analysis Notes"
author: "David M Wright - d.wright@qub.ac.uk"
date: "Document compiled: `r Sys.Date()`"
output: 
  bookdown::html_document2:
     toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(rprojroot)
```

`r R.version.string`   

# Introduction   

This analysis is of Electronic Medical Records (EMR) from the Belfast Health and Social Care Trust Macular Service. The aims are to describe the pattern of anti-VEGF injection intervals among patients receiving treatment for Diabetic Macular Oedema (DMO). Of particular interest are those patients that were able to have injection intervals consistently extended over 12 weeks duration.

```{r run-analysis, include=FALSE}
source(find_rstudio_root_file("Code/assemble-EMR-data.R"))
```

# Cohort construction

## Pre-processing 

The data structure is defined in the file `Novartis DMO Study - Data Dictionary v1.1.xls` and a total of 18 separate pipe delimited files were provided (Table \@ref(tab:table-descriptions)). Data were extracted on `r as.Date(max(patients$ExtractDate))`.   

```{r table-descriptions}
tibble(`Table name` = names(emr_tables),
       Rows = map_dbl(emr_tables, nrow),
       Columns = map_dbl(emr_tables, ncol)) %>% 
  mutate(`Table number` = row_number()) %>% 
  inner_join(emr_tables_desc, by = "Table name") %>% 
  select(`Table number`, everything()) %>% 
  kbl(caption = "Description of input data files.") %>% 
  kable_paper()
```

The following steps were taken to pre-process the data:   


### DMOVisualAcuity table

* Conversion of visual acuity measurements to both ETDRS and logMAR formats.   

### DMOInjections table

* Add visual acuity measurements to the corresponding injection.
* Removal of `r nrow(filter(injections_raw, exclude_not_antiVEGF))` injections that were not for anti-VEGF agents.
* Removal of `r nrow(filter(injections_raw, !exclude_not_antiVEGF, exclude_duplicate_encounter))` duplicate injection entries.   

A total of `r nrow(injections_clean)` injection records remained after these removals.


### Eye summary

* Identification of the first injection recorded for each eye and the date (the index date).   
* Calculation of patient ages at the index date and at study period end and total observation period for each eye.   
* Creation of new table (`eye`) containing patient details, follow up period and baseline VA.


* Calculation of treatment intervals.   



## Inclusion and exclusion criteria

Data were extracted by Medisoft with the following inclusion  and  exclusion criteria. 

Inclusion: "Any patient having attended the BHSCT macular treatment service at least once during the period May 2008 to date of extraction with a diagnosis DR/DMO."   
Exclusion: "Any patient marked as a test patient."

EMR for a total of `r nrow(patients)` patients were included in the extracted dataset, with `r nrow(injections)` valid records of anti-VEGF injections. The unit of analysis is the eye so criteria were applied at the eye level:   

* `r nrow(eye_raw)` eyes received at least one anti-VEGF injection.   
* `r nrow(filter(eye_raw, !exclude_age, exclude_no_intervals))` eyes that received no injections after the index date were excluded.

A total of `r nrow(eye)` eyes from `r nrow(distinct(eye, PatientID))` patients remained after these exclusions. A total of `r nrow(injections)` injection records remained giving `r as.integer(sum(eye$total_intervals))` treatment intervals (between injections). 



# Descriptive statistics

```{r descriptives}
indiv %>% 
  transmute(Age = index_age, Gender, Treated, Individuals = " ") %>% 
  GenerateDescriptives(type = c(Age = "Median (Range)")) %>% 
  kbl(caption = "Baseline demographics and characteristics of patients with DMO. Frequency and percentage reported for categorical variables.") %>% 
  kable_paper()

```

```{r va-baseline}
eye %>% 
  select(`ETDRS letters`,`ETDRS category`) %>% 
  mutate(Eyes = " ") %>% 
  GenerateDescriptives() %>% 
  kbl(caption = "Visual acuity at baseline.") %>% 
  kable_paper()
```
# Treatment sequences

```{r treatment-intervals, fig.cap= "Treatment sequences for a sample of eyes.", fig.height = 7}
treatment_intervals %>% 
  filter(PatientID %in% sample(PatientID, 30)) %>% 
  ggplot(aes(x = treatment_interval_weeks, y = sequence_id, group = sequence_id, fill = `Treatment interval`)) +
  geom_col(colour = "white") +
  theme_light() +
  scale_x_continuous(breaks = seq(0, 312, by = 52)) +
  labs(x = "Weeks since index injection", y = "Sequence ID")
```
