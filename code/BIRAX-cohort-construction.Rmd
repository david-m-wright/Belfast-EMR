---
title: "BIRAX study - Cohort construction"
author: "David M Wright - d.wright@qub.ac.uk"
date: "Document compiled: `r Sys.Date()`"
output: 
  bookdown::html_document2:
     toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(rprojroot)
```

`r R.version.string`   

# Introduction

This analysis is of Electronic Medical Records (EMR) from the Belfast Health and Social Care Trust Macular Service. The aim of the study is to investigate the potential for machine learning to identify factors and biomarkers associated with long-term AMD treatment response.

This document describes construction of the analysis cohort. Pre-processing of the Medisoft and fluid data are described in 'BIRAX-assemble-Medisoft-data-notes.Rmd` and `BIRAX-assemble-NOA-data-notes.Rmd` respectively.

```{r run-analysis, include=FALSE}
source(find_rstudio_root_file("Code/BIRAX-assemble-Medisoft-data.R"))
```


# Cohort construction

Data were extracted on `r as.Date(max(patients$ExtractDate))`. A proportion of event dates were after the recorded `ExtractDate`. For example, in the `Encounters` table `r nrow(filter(encounters, EncounterDate > ExtractDate))` records had an `EncounterDate` after the `ExtractDate`. This is related to the date perturbation used by Medisoft to maintain patient anonymity in the extract.

The following steps were taken to process the data:   

Injections   

* Removal of a small number of injections that were not for anti-VEGF agents.
* Removal of a small number of duplicate injection entries.   
* Identification of the first injection recorded for each eye and the date (the index date).   
* Calculation of treatment intervals.   

Patient demographics    

* Calculation of patient ages at the index date and at study period end and total observation period for each eye.   

Visual acuity

* Conversion of visual acuity measurements to both ETDRS and logMAR formats.   
* Categorisation of visual acuity into 4 Snellen categories (calculations in logMAR units).   
* At each VA measurement calculate VA change (logMAR and ETDRS) since the baseline (index date).    
* Categorise VA change since baseline in ETDRS lines (calculations in logMAR units)).  
* Identification of the closest VA measurements to each time point of interest during treatment.   

Diagnoses   

* Identification of eyes with a diagnosis of AMD (`CoPathologyCode` "R316" or "R337" in Table \@ref(tab:co-pathology), or DiagnosisDescription containing "AMD" or "age-related macular degeneration" in Table \@ref(tab:diagnoses). Those with "suspected AMD" or "dry AMD" at first diagnosis were excluded (those developing dry AMD later were not excluded)).   
* Identification of eyes with a diagnosis of retinal vein or artery occlusions (RVO).   
* Identification of eyes with a diagnosis of diabetic macular oedema (DMO) or diabetic retinopathy (DR)  (`CoPathologyCode` "R318" in Table \@ref(tab:co-pathology) or `DiagnosisDescription` contining "diabetic macular oedema" in Table \@ref(tab:diagnoses) or any features found in Table \@ref(tab:DR-assessment)).   


## Inclusion and exclusion criteria

Data were extracted by Medisoft with the following inclusion and  exclusion criteria. 

Inclusion: "Any patient having attended the BHSCT macular treatment service at least once during the period May 2008 to May 2018 with a diagnosis of AMD, DR/DMO or RVO."   
Exclusion: "Any patient marked as a test patient."

EMR for a total of `r nrow(patients)` patients were included in the extracted dataset, with `r nrow(injections_raw)` records of anti-VEGF injections. The unit of analysis is the eye so criteria were applied at the eye level:   

* The raw data contained `r nrow(eye_raw)` eyes.   
* `r nrow(filter(eye_raw, exclude_no_AMD))` eyes had no diagnosis of age-related macular degeneration and were excluded. 
* `r nrow(filter(eye_raw, !exclude_no_AMD, exclude_age))` eyes were in patients aged <50 at the index date and were excluded.
* `r nrow(filter(eye_raw, !exclude_no_AMD, !exclude_age,  exclude_lt3_injections))` eyes had fewer than three anti-VEGF injections during the study period  and were excluded.   
* `r nrow(filter(eye_raw, !exclude_no_AMD, !exclude_age,  !exclude_lt3_injections, exclude_RVO))` eyes had a diagnosis of RVO at any point during the study period and were excluded.   
* `r nrow(filter(eye_raw, !exclude_no_AMD, !exclude_age,  !exclude_lt3_injections, !exclude_RVO, exclude_DR_DMO))` eyes had a diagnosis of DMO/DR at any point during the study period and were excluded.   
* `r nrow(filter(eye_raw, !exclude_no_AMD, !exclude_age,  !exclude_lt3_injections, !exclude_RVO, !exclude_DR_DMO, exclude_no_va))` eyes did not have a visual acuity assessment on the index date and were excluded.   


A total of `r nrow(eye)` eyes from `r nrow(distinct(eye, PatientID))` patients remained after these exclusions. A total of `r nrow(injections)` injections were observed for the cohort, allowing `r nrow(treatment_intervals)` treatment intervals to be observed (between injections). 


# Descriptive statistics

Descriptive statistics for the eyes included in the analysis are given in Tables \@ref(tab:descriptives). Statistics are presented at the eye level as some patients were treated in both eyes, with treatment starting at different times. Table \@ref(tab:va-descriptives) gives visual acuity outcomes at the times of interest listed in Table \@ref(tab:snapshots). The distribution of OCT assessments, injections and injection intervals are given by treatment year in Tables \@ref(tab:oct-by-year), \@ref(tab:injections-by-year) and \@ref(tab:injection-intervals-by-year).

```{r descriptives}
eye %>%
  transmute(Age = index_age, Gender, Eyes = " ") %>%
  GenerateDescriptives(type = c(Age = "Mean (Range)")) %>%
  kbl(caption = "Baseline demographics of eyes with AMD. Frequency and percentage reported for categorical variables.") %>%
  kable_paper()
```

There was a pattern of slight improvements in visual acuity by the end of the first year of treatment (Table \@ref(tab:va-descriptives)). This was followed by a steady decline in the subsequent years, with mean VA returning to baseline levels between years 3 and 4 and declining further in the remaining years. 

```{r va-descriptives}
va_history %>% 
  filter(snapshot) %>%
  transmute(follow_up_year, va_logmar, va_change_logmar, va_etdrs, va_change_etdrs, va_change_lines, va_category_snellen, Eyes = "n") %>% 
  GenerateDescriptives(col_var = follow_up_year,
                       type = c(va_logmar = "Mean (Range)", va_etdrs = "Median (IQR)", va_change_etdrs = "Median (IQR)")) %>%
  left_join(var_desc, by = "Variable") %>%
   mutate(Description = coalesce(Description, Variable)) %>%
  select(Description, everything(), -Variable) %>%
  kbl(caption = "Distribution of visual acuity outcomes at the end of each year of anti-VEGF treatment. '0' indicates baseline measurements.") %>% 
  kable_paper()
```

```{r snapshots}
snapshots %>% 
  transmute(`Follow up time (years)` = follow_up_year, `Acceptable tolerance (months)` = tolerance) %>% 
  kbl(caption = "Time points of interest during anti-VEGF treatment for AMD. Tolerance indicates the maximum distance from the point of interest within which a measurement would be included in analysis.") %>% 
  kable_paper()
```

Frequency of both OCT exams and injections decreased with each year of treatment (Tables \@ref(tab:oct-by-year) and \@ref(tab:injections-by-year)), corresponding to modest increases in the proportion of eyes with at least one treatment interval > 80 days in each year of treatment (Table \@ref(tab:injection-intervals-by-year)). Patients may/may not have received an OCT/injection in a given year, so different denominators are used in each of these tables, none of which gives the total number of eyes under treatment (this could be calculated from the overall injection history records).

```{r oct-by-year}
bind_rows(
    oct_history %>% 
      count(PatientID, EyeCode, treatment_year, name = "OCT exams") %>% 
      inner_join(snapshots %>% 
                   filter(follow_up_year != "0"), by = c("treatment_year" = "follow_up_year")) %>% 
      mutate(Received = cut(`OCT exams`, breaks = c(0,4,7, max(.$`OCT exams`)),
                        labels = c("<5 per year", "5-7 per year", ">=8 per year")),
             Eyes = " ") %>% 
      select(treatment_year,  `OCT exams`, Received, Eyes) %>% 
      GenerateDescriptives(col_var = treatment_year),
    
    oct_history %>% 
      transmute(treatment_year, `Total OCT exams` = " ") %>% 
      inner_join(snapshots %>% 
                   filter(follow_up_year != "0") %>% select(follow_up_year), by = c("treatment_year" = "follow_up_year")) %>% 
      GenerateDescriptives(col_var = treatment_year)
  ) %>% 
    kbl(caption = "Distribution of OCT exams received by year of anti-VEGF treatment.") %>% 
    kable_paper()
```


```{r injections-by-year}
bind_rows(
  injections %>% 
  count(PatientID, EyeCode, treatment_year, name = "Injections") %>% 
  inner_join(snapshots %>% 
                   filter(follow_up_year != "0"), by = c("treatment_year" = "follow_up_year")) %>% 
  mutate(Received = cut(Injections, breaks = c(0,4,7, max(.$Injections)),
                        labels = c("<5 per year", "5-7 per year", ">=8 per year")),
    Eyes = " ") %>% 
  select(treatment_year,  Injections, Received, Eyes) %>% 
  GenerateDescriptives(col_var = treatment_year),

  injections %>% 
  transmute(treatment_year, `Total injections` = " ") %>% 
    inner_join(snapshots %>% 
                   filter(follow_up_year != "0") %>% select(follow_up_year), by = c("treatment_year" = "follow_up_year")) %>% 
  GenerateDescriptives(col_var = treatment_year)
) %>% 
  kbl(caption = "Distribution of injections received by year of anti-VEGF treatment.") %>% 
  kable_paper()
```

```{r injection-intervals-by-year}
bind_rows(
    treatment_intervals %>% 
      group_by(PatientID, EyeCode, treatment_year) %>% 
      summarise(`Treatment intervals` = n(), 
                interval_gt80 = any(treatment_interval_days > 80),
                interval_leq40 = any(treatment_interval_days <= 40), .groups = "drop") %>% 
      inner_join(snapshots %>% 
                   filter(follow_up_year != "0"), by = c("treatment_year" = "follow_up_year")) %>% 
      mutate(`Extended interval (>80 days)` = if_else(interval_gt80, "Yes", "No"),
             `Short interval (<=40 days)` = if_else(interval_leq40, "Yes", "No"),
             Eyes = " ") %>% 
      select(treatment_year, `Treatment intervals`,  `Extended interval (>80 days)`,`Short interval (<=40 days)`, Eyes) %>% 
      GenerateDescriptives(col_var = treatment_year),
    
    treatment_intervals %>% 
      transmute(treatment_year, `Total treatment intervals` = " ") %>% 
      inner_join(snapshots %>% 
                   filter(follow_up_year != "0")%>% 
                   select(follow_up_year), by = c("treatment_year" = "follow_up_year")) %>% 
      GenerateDescriptives(col_var = treatment_year)
  ) %>% 
    kbl(caption = "Distribution of treatment intervals by year of anti-VEGF treatment. Intervals were assigned to years based on where the start of the treatment interval fell.") %>% 
    kable_paper()
```

## Outcomes by visual acuity at baseline

```{r va-descriptives-by-baseline-va}
bind_rows(
  va_history %>%
    filter(snapshot) %>% 
    transmute(follow_up_year, va_logmar, va_category_snellen) %>%
    group_by(va_category_snellen) %>%
    nest() %>%
    mutate(df = map(
      .x = data,
      .f = ~ GenerateDescriptives(., col_var = follow_up_year)
    )) %>%
    select(-data) %>%
    unnest(cols = c(df)) %>%
    arrange(va_category_snellen),
  
  va_history %>%
    filter(snapshot) %>% 
    transmute(follow_up_year, va_change_lines, va_category_snellen, Eyes = "n") %>%
    group_by(va_category_snellen) %>%
    nest() %>%
    mutate(df = map(
      .x = data,
      .f = ~ GenerateDescriptives(., col_var = follow_up_year)
    )) %>%
    select(-data) %>%
    unnest(cols = c(df)) %>%
    arrange(va_category_snellen)
) %>%
  
  left_join(var_desc, by = "Variable") %>%
  mutate(Description = coalesce(Description, Variable)) %>%
  select(Description, everything(),-Variable) %>%
  rename(`Baseline VA category` = va_category_snellen) %>%
  kbl(caption = "Distribution of visual acuity outcomes at the end of each year of anti-VEGF treatment by baseline visual acuity. '0' indicates baseline measurements.") %>%
  kable_paper()
```

```{r injections-by-year-by-baseline-va}
bind_rows(
# Find baseline VA
  va_history %>% 
  filter(snapshot, follow_up_year == 0) %>%
  select(PatientID, EyeCode, va_category_snellen) %>% 
# Join injections in the years of interest
    inner_join(injections, by = c("PatientID", "EyeCode")) %>% 
  inner_join(snapshots %>% 
                   filter(follow_up_year != "0"), by = c("treatment_year" = "follow_up_year")) %>% 
  # Count the injections per eye per year
  count(PatientID, EyeCode, va_category_snellen, treatment_year, name = "Injections") %>% 
  select(-PatientID, -EyeCode) %>% 
  group_by(va_category_snellen) %>%
    nest() %>%
    mutate(df = map(
      .x = data,
      .f = ~ GenerateDescriptives(., col_var = treatment_year)
    )) %>%
    select(-data) %>%
    unnest(cols = c(df)) %>% 
  arrange(va_category_snellen),

  # Find baseline VA
va_history %>% 
  filter(snapshot, follow_up_year == 0) %>%
  select(PatientID, EyeCode, va_category_snellen) %>% 
# Join injections in the years of interest
  inner_join(injections, by = c("PatientID", "EyeCode")) %>% 
  inner_join(snapshots %>% 
                   filter(follow_up_year != "0"), by = c("treatment_year" = "follow_up_year")) %>% 
  # Count the injections per eye per year
  count(PatientID, EyeCode, va_category_snellen, treatment_year, name = "Injections") %>% 
mutate(Received = cut(Injections, breaks = c(0,4,7, max(.$Injections)),
                        labels = c("<5 per year", "5-7 per year", ">=8 per year")),
       Eyes = " ") %>%   
  
  select(-PatientID, -EyeCode, -Injections) %>% 
  group_by(va_category_snellen) %>%
    nest() %>%
    mutate(df = map(
      .x = data,
      .f = ~ GenerateDescriptives(., col_var = treatment_year)
    )) %>%
    select(-data) %>%
    unnest(cols = c(df)) %>% 
  arrange(va_category_snellen)

) %>% 
  rename(`Baseline VA category` = va_category_snellen) %>%
  kbl(caption = "Distribution of injections received by year of anti-VEGF treatment and baseline visual acuity.") %>% 
  kable_paper()
```


